<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM Dashboard - Phase 3</title>
    
    <!-- Phase 3: CRM Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.emailjs.com/dist/email.min.js"></script>
    
    <!-- Configuration System -->
    <script src="config.js"></script>
    
    <style>
        :root {
            --primary-gold: #D4B062;
            --light-gold: #F4E4A1;
            --cream: #FBF8F0;
            --warm-white: #FEFCF7;
            --charcoal: #2C2C2C;
            --dark-gray: #4A4A4A;
            --light-gray: #E8E8E8;
            --success: #2E7D4A;
            --warning: #C5801A;
            --danger: #C5281A;
            --info: #2E7DC5;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, var(--warm-white) 0%, var(--cream) 100%);
            color: var(--charcoal);
            line-height: 1.6;
            min-height: 100vh;
        }

        /* Navigation */
        .nav-header {
            background: white;
            border-bottom: 1px solid var(--light-gray);
            padding: 1rem 0;
        }

        .nav-container {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: center;
            gap: 2rem;
            padding: 0 2rem;
        }

        .nav-item {
            color: var(--dark-gray);
            text-decoration: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            transition: all 0.3s ease;
            font-weight: 500;
            font-size: 0.9rem;
        }

        .nav-item:hover {
            background: var(--light-gold);
            color: var(--charcoal);
        }

        .nav-item.active {
            background: var(--primary-gold);
            color: white;
        }

        /* CRM Container */
        .crm-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .crm-header {
            background: linear-gradient(135deg, var(--primary-gold), #C5A055);
            color: white;
            padding: 2rem;
            border-radius: 16px;
            text-align: center;
            margin-bottom: 2rem;
        }

        .crm-title {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .crm-subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        /* Action Bar */
        .action-bar {
            background: white;
            border-radius: 12px;
            padding: 1.5rem 2rem;
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
        }

        .quick-actions {
            display: flex;
            gap: 1rem;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: var(--primary-gold);
            color: white;
        }

        .btn-primary:hover {
            background: #C5A055;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: white;
            color: var(--primary-gold);
            border: 2px solid var(--primary-gold);
        }

        .btn-secondary:hover {
            background: var(--primary-gold);
            color: white;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover {
            background: #246B3A;
        }

        .btn-warning {
            background: var(--warning);
            color: white;
        }

        .btn-warning:hover {
            background: #A66C15;
        }

        /* CRM Stats */
        .crm-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
            border-left: 4px solid var(--primary-gold);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-4px);
        }

        .stat-card.success {
            border-left-color: var(--success);
        }

        .stat-card.warning {
            border-left-color: var(--warning);
        }

        .stat-card.info {
            border-left-color: var(--info);
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .stat-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--dark-gray);
            text-transform: uppercase;
        }

        .stat-icon {
            font-size: 1.5rem;
            opacity: 0.7;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--charcoal);
            margin-bottom: 0.5rem;
        }

        .stat-description {
            font-size: 0.9rem;
            color: var(--dark-gray);
        }

        /* Lead Management */
        .lead-section {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--charcoal);
        }

        /* Lead Filters */
        .lead-filters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: var(--cream);
            border-radius: 12px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .filter-label {
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--dark-gray);
        }

        .filter-input {
            padding: 0.5rem;
            border: 1px solid var(--light-gray);
            border-radius: 6px;
            font-size: 0.9rem;
        }

        /* Lead List */
        .lead-list {
            display: grid;
            gap: 1rem;
        }

        .lead-card {
            background: var(--warm-white);
            border: 1px solid var(--light-gray);
            border-radius: 12px;
            padding: 1.5rem;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .lead-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.1);
        }

        .lead-card.new {
            border-left: 4px solid var(--info);
        }

        .lead-card.contacted {
            border-left: 4px solid var(--warning);
        }

        .lead-card.qualified {
            border-left: 4px solid var(--primary-gold);
        }

        .lead-card.paid {
            border-left: 4px solid var(--success);
        }

        .lead-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .lead-name {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--charcoal);
        }

        .lead-status {
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
            text-transform: uppercase;
        }

        .lead-status.new {
            background: var(--info);
            color: white;
        }

        .lead-status.contacted {
            background: var(--warning);
            color: white;
        }

        .lead-status.qualified {
            background: var(--primary-gold);
            color: white;
        }

        .lead-status.paid {
            background: var(--success);
            color: white;
        }

        .lead-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .lead-detail {
            display: flex;
            flex-direction: column;
        }

        .detail-label {
            font-size: 0.8rem;
            color: var(--dark-gray);
            margin-bottom: 0.25rem;
        }

        .detail-value {
            font-weight: 500;
            color: var(--charcoal);
        }

        .lead-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .action-btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .action-btn.primary {
            background: var(--primary-gold);
            color: white;
        }

        .action-btn.primary:hover {
            background: #C5A055;
        }

        .action-btn.secondary {
            background: var(--light-gray);
            color: var(--dark-gray);
        }

        .action-btn.secondary:hover {
            background: var(--dark-gray);
            color: white;
        }

        /* Lead Detail Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            max-width: 800px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--light-gray);
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--charcoal);
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--dark-gray);
        }

        /* Communication Panel */
        .communication-panel {
            background: var(--cream);
            border-radius: 12px;
            padding: 1.5rem;
            margin: 1rem 0;
        }

        .communication-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--charcoal);
            margin-bottom: 1rem;
        }

        .message-form {
            display: grid;
            gap: 1rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .form-label {
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--dark-gray);
        }

        .form-input,
        .form-textarea {
            padding: 0.75rem;
            border: 1px solid var(--light-gray);
            border-radius: 6px;
            font-size: 0.9rem;
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }

        /* Email Templates */
        .template-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .template-btn {
            padding: 0.5rem 1rem;
            border: 1px solid var(--light-gray);
            border-radius: 6px;
            background: white;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s ease;
        }

        .template-btn:hover {
            background: var(--light-gold);
        }

        .template-btn.active {
            background: var(--primary-gold);
            color: white;
            border-color: var(--primary-gold);
        }

        /* Activity Timeline */
        .activity-timeline {
            margin: 2rem 0;
        }

        .timeline-item {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--light-gray);
        }

        .timeline-item:last-child {
            border-bottom: none;
        }

        .timeline-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary-gold);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.9rem;
            flex-shrink: 0;
        }

        .timeline-content {
            flex: 1;
        }

        .timeline-title {
            font-weight: 600;
            color: var(--charcoal);
            margin-bottom: 0.25rem;
        }

        .timeline-description {
            color: var(--dark-gray);
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
        }

        .timeline-date {
            color: var(--dark-gray);
            font-size: 0.8rem;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .crm-container {
                padding: 1rem;
            }

            .action-bar {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }

            .quick-actions {
                flex-wrap: wrap;
                justify-content: center;
            }

            .lead-filters {
                grid-template-columns: 1fr;
            }

            .lead-details {
                grid-template-columns: 1fr;
            }

            .modal-content {
                width: 95%;
                padding: 1rem;
            }
        }

        /* Loading States */
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(212, 176, 98, 0.3);
            border-radius: 50%;
            border-top-color: var(--primary-gold);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="nav-header">
        <div class="nav-container">
            <a href="index.html" class="nav-item">🏠 Business Hub</a>
            <a href="admin-dashboard.html" class="nav-item">📊 Admin Dashboard</a>
            <a href="enhanced-client-proposal-phase3.html" class="nav-item">📋 Smart Configurator</a>
            <a href="analytics-dashboard.html" class="nav-item">📈 Analytics</a>
            <a href="crm-dashboard.html" class="nav-item active">👥 CRM</a>
        </div>
    </nav>

    <!-- CRM Container -->
    <div class="crm-container">
        <!-- Header -->
        <div class="crm-header">
            <h1 class="crm-title" id="crm-title">Customer Relationship Management</h1>
            <p class="crm-subtitle" id="crm-subtitle">Manage leads, track interactions, and automate communications</p>
        </div>

        <!-- Action Bar -->
        <div class="action-bar">
            <div class="quick-actions">
                <button class="btn btn-primary" onclick="addNewLead()">➕ Add Lead</button>
                <button class="btn btn-secondary" onclick="sendBulkEmail()">📧 Bulk Email</button>
                <button class="btn btn-secondary" onclick="exportLeads()">📥 Export</button>
                <button class="btn btn-success" onclick="syncIntegrations()">🔄 Sync</button>
            </div>
            <div>
                <span style="color: var(--dark-gray); font-size: 0.9rem;">
                    Last sync: <span id="lastSync">--</span>
                </span>
            </div>
        </div>

        <!-- CRM Stats -->
        <div class="crm-stats">
            <div class="stat-card">
                <div class="stat-header">
                    <span class="stat-title">Total Leads</span>
                    <span class="stat-icon">👥</span>
                </div>
                <div class="stat-value" id="totalLeads">0</div>
                <div class="stat-description">All time lead count</div>
            </div>

            <div class="stat-card success">
                <div class="stat-header">
                    <span class="stat-title">Active Pipeline</span>
                    <span class="stat-icon">🔄</span>
                </div>
                <div class="stat-value" id="activePipeline">0</div>
                <div class="stat-description">Leads in progress</div>
            </div>

            <div class="stat-card warning">
                <div class="stat-header">
                    <span class="stat-title">Follow-ups Due</span>
                    <span class="stat-icon">⏰</span>
                </div>
                <div class="stat-value" id="followupsDue">0</div>
                <div class="stat-description">Require attention today</div>
            </div>

            <div class="stat-card info">
                <div class="stat-header">
                    <span class="stat-title">Conversion Rate</span>
                    <span class="stat-icon">🎯</span>
                </div>
                <div class="stat-value" id="conversionRate">0%</div>
                <div class="stat-description">Last 30 days</div>
            </div>
        </div>

        <!-- Lead Management Section -->
        <div class="lead-section">
            <div class="section-header">
                <h2 class="section-title">Lead Management</h2>
                <button class="btn btn-primary" onclick="refreshLeads()">🔄 Refresh</button>
            </div>

            <!-- Lead Filters -->
            <div class="lead-filters">
                <div class="filter-group">
                    <label class="filter-label">Status</label>
                    <select class="filter-input" id="statusFilter">
                        <option value="all">All Status</option>
                        <option value="new">New</option>
                        <option value="contacted">Contacted</option>
                        <option value="qualified">Qualified</option>
                        <option value="paid_deposit">Paid Deposit</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">Source</label>
                    <select class="filter-input" id="sourceFilter">
                        <option value="all">All Sources</option>
                        <option value="configurator">Configurator</option>
                        <option value="referral">Referral</option>
                        <option value="website">Website</option>
                        <option value="social">Social Media</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">Project Type</label>
                    <select class="filter-input" id="projectFilter">
                        <option value="all">All Projects</option>
                        <option value="kitchen">Kitchen</option>
                        <option value="bathroom">Bathroom</option>
                        <option value="custom">Custom</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">Search</label>
                    <input type="text" class="filter-input" id="searchFilter" placeholder="Search by name or email">
                </div>
            </div>

            <!-- Lead List -->
            <div class="lead-list" id="leadList">
                <!-- Dynamic content -->
            </div>
        </div>
    </div>

    <!-- Lead Detail Modal -->
    <div class="modal-overlay" id="leadModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">Lead Details</h2>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            
            <div id="modalContent">
                <!-- Dynamic content -->
            </div>
        </div>
    </div>

    <script>
        // Phase 3: Comprehensive CRM System
        class CRMDashboard {
            constructor() {
                this.leads = JSON.parse(localStorage.getItem('crm_leads') || '[]');
                this.analytics = JSON.parse(localStorage.getItem('crm_analytics') || '{}');
                this.emailTemplates = this.initEmailTemplates();
                this.filters = {
                    status: 'all',
                    source: 'all',
                    project: 'all',
                    search: ''
                };
                this.initEmailJS();
                this.init();
            }

            initEmailJS() {
                if (typeof emailjs !== 'undefined') {
                    emailjs.init("YOUR_EMAILJS_USER_ID");
                }
            }

            init() {
                this.updateStats();
                this.renderLeads();
                this.updateLastSync();
                this.bindEventListeners();
                
                // Auto-refresh every 2 minutes
                setInterval(() => {
                    this.updateStats();
                    this.renderLeads();
                    this.updateLastSync();
                }, 120000);
            }

            bindEventListeners() {
                // Filter event listeners
                document.getElementById('statusFilter').addEventListener('change', () => this.applyFilters());
                document.getElementById('sourceFilter').addEventListener('change', () => this.applyFilters());
                document.getElementById('projectFilter').addEventListener('change', () => this.applyFilters());
                document.getElementById('searchFilter').addEventListener('input', () => this.applyFilters());
            }

            updateStats() {
                const totalLeads = this.leads.length;
                const activePipeline = this.leads.filter(lead => 
                    ['new', 'contacted', 'qualified'].includes(lead.status)
                ).length;
                
                const followupsDue = this.getFollowupsDue().length;
                
                const conversionRate = totalLeads > 0 
                    ? ((this.leads.filter(lead => lead.status === 'paid_deposit').length / totalLeads) * 100).toFixed(1)
                    : 0;

                document.getElementById('totalLeads').textContent = totalLeads;
                document.getElementById('activePipeline').textContent = activePipeline;
                document.getElementById('followupsDue').textContent = followupsDue;
                document.getElementById('conversionRate').textContent = conversionRate + '%';
            }

            getFollowupsDue() {
                const today = new Date().toDateString();
                return this.leads.filter(lead => {
                    if (!lead.followUpDate) return false;
                    const followUpDate = new Date(lead.followUpDate).toDateString();
                    return followUpDate <= today && !['paid_deposit', 'closed'].includes(lead.status);
                });
            }

            applyFilters() {
                this.filters.status = document.getElementById('statusFilter').value;
                this.filters.source = document.getElementById('sourceFilter').value;
                this.filters.project = document.getElementById('projectFilter').value;
                this.filters.search = document.getElementById('searchFilter').value.toLowerCase();
                
                this.renderLeads();
            }

            getFilteredLeads() {
                return this.leads.filter(lead => {
                    // Status filter
                    if (this.filters.status !== 'all' && lead.status !== this.filters.status) {
                        return false;
                    }
                    
                    // Source filter
                    if (this.filters.source !== 'all' && lead.source !== this.filters.source) {
                        return false;
                    }
                    
                    // Project filter
                    if (this.filters.project !== 'all' && lead.estimate?.projectType !== this.filters.project) {
                        return false;
                    }
                    
                    // Search filter
                    if (this.filters.search) {
                        const searchText = (lead.client?.name + ' ' + lead.client?.email).toLowerCase();
                        if (!searchText.includes(this.filters.search)) {
                            return false;
                        }
                    }
                    
                    return true;
                });
            }

            renderLeads() {
                const container = document.getElementById('leadList');
                const filteredLeads = this.getFilteredLeads();
                
                if (filteredLeads.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 3rem; color: var(--dark-gray);">
                            <h3>No leads found</h3>
                            <p>Try adjusting your filters or add new leads.</p>
                            <button class="btn btn-primary" onclick="addNewLead()" style="margin-top: 1rem;">➕ Add First Lead</button>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = filteredLeads.map(lead => this.renderLeadCard(lead)).join('');
            }

            renderLeadCard(lead) {
                const isOverdue = this.isFollowupOverdue(lead);
                const estimateTotal = lead.estimate?.total || 0;
                const clientName = lead.client?.name || 'Unknown';
                const projectType = lead.estimate?.projectType || 'N/A';
                const source = lead.source || 'Direct';
                const createdDate = new Date(lead.timestamp).toLocaleDateString();

                return `
                    <div class="lead-card ${lead.status}" onclick="openLeadDetail('${lead.id}')">
                        <div class="lead-header">
                            <h3 class="lead-name">${clientName}</h3>
                            <span class="lead-status ${lead.status}">${lead.status.replace('_', ' ')}</span>
                        </div>
                        
                        <div class="lead-details">
                            <div class="lead-detail">
                                <span class="detail-label">Project</span>
                                <span class="detail-value">${projectType.toUpperCase()}</span>
                            </div>
                            <div class="lead-detail">
                                <span class="detail-label">Value</span>
                                <span class="detail-value">${this.formatCurrency(estimateTotal)}</span>
                            </div>
                            <div class="lead-detail">
                                <span class="detail-label">Source</span>
                                <span class="detail-value">${source}</span>
                            </div>
                            <div class="lead-detail">
                                <span class="detail-label">Created</span>
                                <span class="detail-value">${createdDate}</span>
                            </div>
                            ${lead.followUpDate ? `
                                <div class="lead-detail">
                                    <span class="detail-label">Follow-up</span>
                                    <span class="detail-value ${isOverdue ? 'style="color: var(--danger); font-weight: 600;"' : ''}">${lead.followUpDate}</span>
                                </div>
                            ` : ''}
                        </div>
                        
                        <div class="lead-actions">
                            <button class="action-btn primary" onclick="event.stopPropagation(); sendEmail('${lead.id}')">📧 Email</button>
                            <button class="action-btn secondary" onclick="event.stopPropagation(); updateStatus('${lead.id}')">Update</button>
                            <button class="action-btn secondary" onclick="event.stopPropagation(); addNote('${lead.id}')">💬 Note</button>
                            ${isOverdue ? '<button class="action-btn" style="background: var(--danger); color: white;" onclick="event.stopPropagation(); scheduleFollowup(\'' + lead.id + '\')">⚠️ Overdue</button>' : ''}
                        </div>
                    </div>
                `;
            }

            isFollowupOverdue(lead) {
                if (!lead.followUpDate || ['paid_deposit', 'closed'].includes(lead.status)) {
                    return false;
                }
                const today = new Date();
                const followUpDate = new Date(lead.followUpDate);
                return followUpDate < today;
            }

            openLeadDetail(leadId) {
                const lead = this.leads.find(l => l.id == leadId);
                if (!lead) return;

                document.getElementById('modalTitle').textContent = `${lead.client?.name || 'Unknown Lead'} - Details`;
                
                const modalContent = document.getElementById('modalContent');
                modalContent.innerHTML = this.renderLeadDetailContent(lead);
                
                document.getElementById('leadModal').classList.add('active');
            }

            renderLeadDetailContent(lead) {
                const activities = this.getLeadActivities(lead);
                
                return `
                    <!-- Lead Overview -->
                    <div style="background: var(--cream); padding: 1.5rem; border-radius: 12px; margin-bottom: 2rem;">
                        <h3 style="margin-bottom: 1rem; color: var(--charcoal);">Contact Information</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                            <div>
                                <strong>Name:</strong> ${lead.client?.name || 'N/A'}<br>
                                <strong>Email:</strong> ${lead.client?.email || 'N/A'}<br>
                                <strong>Phone:</strong> ${lead.client?.phone || 'N/A'}
                            </div>
                            <div>
                                <strong>Address:</strong> ${lead.client?.address || 'N/A'}<br>
                                <strong>Source:</strong> ${lead.source || 'Direct'}<br>
                                <strong>Status:</strong> <span class="lead-status ${lead.status}">${lead.status.replace('_', ' ')}</span>
                            </div>
                        </div>
                    </div>

                    <!-- Project Details -->
                    <div style="background: var(--warm-white); padding: 1.5rem; border-radius: 12px; margin-bottom: 2rem;">
                        <h3 style="margin-bottom: 1rem; color: var(--charcoal);">Project Details</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                            <div>
                                <strong>Type:</strong> ${lead.estimate?.projectType || 'N/A'}<br>
                                <strong>Package:</strong> ${lead.estimate?.packageType || 'N/A'}<br>
                                <strong>Linear Feet:</strong> ${lead.estimate?.linearFeet || 'N/A'}
                            </div>
                            <div>
                                <strong>Timeline:</strong> ${lead.estimate?.timeline || 'N/A'}<br>
                                <strong>Total Value:</strong> ${this.formatCurrency(lead.estimate?.total || 0)}<br>
                                <strong>Deposit:</strong> ${this.formatCurrency(lead.depositAmount || 0)}
                            </div>
                        </div>
                    </div>

                    <!-- Communication Panel -->
                    <div class="communication-panel">
                        <h3 class="communication-title">Send Message</h3>
                        
                        <!-- Email Templates -->
                        <div class="template-selector">
                            <button class="template-btn active" onclick="loadEmailTemplate('followUp')">Follow-up</button>
                            <button class="template-btn" onclick="loadEmailTemplate('proposal')">Proposal</button>
                            <button class="template-btn" onclick="loadEmailTemplate('welcome')">Welcome</button>
                            <button class="template-btn" onclick="loadEmailTemplate('custom')">Custom</button>
                        </div>
                        
                        <form class="message-form" onsubmit="sendMessage(event, '${lead.id}')">
                            <div class="form-group">
                                <label class="form-label">Subject</label>
                                <input type="text" class="form-input" id="emailSubject" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Message</label>
                                <textarea class="form-textarea" id="emailMessage" rows="6" required></textarea>
                            </div>
                            <div style="display: flex; gap: 1rem;">
                                <button type="submit" class="btn btn-primary">📧 Send Email</button>
                                <button type="button" class="btn btn-secondary" onclick="saveDraft('${lead.id}')">💾 Save Draft</button>
                            </div>
                        </form>
                    </div>

                    <!-- Activity Timeline -->
                    <div class="activity-timeline">
                        <h3 style="margin-bottom: 1rem; color: var(--charcoal);">Activity Timeline</h3>
                        ${activities.map(activity => this.renderTimelineItem(activity)).join('')}
                    </div>

                    <!-- Lead Actions -->
                    <div style="display: flex; gap: 1rem; margin-top: 2rem; padding-top: 1rem; border-top: 1px solid var(--light-gray);">
                        <button class="btn btn-primary" onclick="updateLeadStatus('${lead.id}')">Update Status</button>
                        <button class="btn btn-secondary" onclick="scheduleFollowup('${lead.id}')">Schedule Follow-up</button>
                        <button class="btn btn-warning" onclick="generateProposal('${lead.id}')">Generate Proposal</button>
                        ${lead.status !== 'paid_deposit' ? `<button class="btn btn-success" onclick="markAsPaid('${lead.id}')">Mark as Paid</button>` : ''}
                    </div>
                `;
            }

            getLeadActivities(lead) {
                const activities = [
                    {
                        type: 'lead_created',
                        title: 'Lead Created',
                        description: `Lead added from ${lead.source || 'direct source'}`,
                        date: lead.timestamp,
                        icon: '👤'
                    }
                ];

                // Add email activities
                for (let i = 0; i < (lead.emailsSent || 0); i++) {
                    activities.push({
                        type: 'email_sent',
                        title: 'Email Sent',
                        description: 'Communication sent to lead',
                        date: new Date(Date.now() - Math.random() * 7 * 24 * 60 * 60 * 1000).toISOString(),
                        icon: '📧'
                    });
                }

                // Add status changes
                if (lead.status !== 'new') {
                    activities.push({
                        type: 'status_change',
                        title: 'Status Updated',
                        description: `Status changed to ${lead.status.replace('_', ' ')}`,
                        date: new Date(Date.now() - Math.random() * 5 * 24 * 60 * 60 * 1000).toISOString(),
                        icon: '🔄'
                    });
                }

                // Add payment if applicable
                if (lead.status === 'paid_deposit') {
                    activities.push({
                        type: 'payment',
                        title: 'Deposit Received',
                        description: `Deposit of ${this.formatCurrency(lead.depositAmount || 0)} received`,
                        date: new Date(Date.now() - Math.random() * 2 * 24 * 60 * 60 * 1000).toISOString(),
                        icon: '💰'
                    });
                }

                return activities.sort((a, b) => new Date(b.date) - new Date(a.date));
            }

            renderTimelineItem(activity) {
                const date = new Date(activity.date).toLocaleDateString();
                const time = new Date(activity.date).toLocaleTimeString();
                
                return `
                    <div class="timeline-item">
                        <div class="timeline-icon">${activity.icon}</div>
                        <div class="timeline-content">
                            <div class="timeline-title">${activity.title}</div>
                            <div class="timeline-description">${activity.description}</div>
                            <div class="timeline-date">${date} at ${time}</div>
                        </div>
                    </div>
                `;
            }

            initEmailTemplates() {
                return {
                    followUp: {
                        subject: "Following up on your cabinet project",
                        body: `Hi {{client_name}},\n\nI wanted to follow up on the cabinet estimate we prepared for your {{project_type}} project.\n\nDo you have any questions about the proposal? I'm here to help refine the details and discuss next steps.\n\nBest regards,\n{{company_name}}`
                    },
                    proposal: {
                        subject: "Your Custom Cabinet Proposal - {{company_name}}",
                        body: `Dear {{client_name}},\n\nThank you for your interest in our cabinet services! Your custom proposal is attached.\n\nProject Details: {{project_type}}\nInvestment: {{estimate_total}}\nTimeline: {{timeline}}\n\nWe're excited to bring your vision to life with exceptional craftsmanship.\n\nBest regards,\n{{company_name}} Team`
                    },
                    welcome: {
                        subject: "Welcome! Your cabinet project journey begins",
                        body: `Dear {{client_name}},\n\nWelcome to {{company_name}}! We're thrilled to help bring your vision to life.\n\nYour Project: {{project_type}}\nEstimated Investment: {{estimate_total}}\n\nWe'll be in touch within 24 hours to discuss your project in detail.\n\nBest regards,\n{{company_name}} Team`
                    },
                    custom: {
                        subject: "",
                        body: ""
                    }
                };
            }

            async sendMessage(event, leadId) {
                event.preventDefault();
                
                const lead = this.leads.find(l => l.id == leadId);
                if (!lead) return;

                const subject = document.getElementById('emailSubject').value;
                const message = document.getElementById('emailMessage').value;

                // Show loading state
                const submitBtn = event.target.querySelector('button[type="submit"]');
                const originalText = submitBtn.innerHTML;
                submitBtn.innerHTML = '<span class="spinner"></span> Sending...';
                submitBtn.disabled = true;

                try {
                    // Send email using EmailJS
                    if (typeof emailjs !== 'undefined') {
                        await emailjs.send('YOUR_SERVICE_ID', 'custom_template', {
                            to_email: lead.client.email,
                            to_name: lead.client.name,
                            subject: subject,
                            message: message,
                            from_name: window.CONFIG?.companyName || 'Your Company'
                        });
                    }

                    // Update lead
                    this.updateLead(leadId, { 
                        emailsSent: (lead.emailsSent || 0) + 1,
                        lastActivity: new Date().toISOString()
                    });

                    alert('Message sent successfully!');
                    
                    // Clear form
                    document.getElementById('emailSubject').value = '';
                    document.getElementById('emailMessage').value = '';
                    
                } catch (error) {
                    console.error('Error sending message:', error);
                    alert('Failed to send message. Please try again.');
                } finally {
                    // Reset button
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                }
            }

            updateLead(leadId, updates) {
                const leadIndex = this.leads.findIndex(lead => lead.id == leadId);
                if (leadIndex !== -1) {
                    this.leads[leadIndex] = { ...this.leads[leadIndex], ...updates };
                    this.saveData();
                    this.updateStats();
                    this.renderLeads();
                }
            }

            saveData() {
                localStorage.setItem('crm_leads', JSON.stringify(this.leads));
            }

            updateLastSync() {
                const now = new Date();
                document.getElementById('lastSync').textContent = now.toLocaleTimeString();
            }

            formatCurrency(amount) {
                return new Intl.NumberFormat('en-US', {
                    style: 'currency',
                    currency: 'USD',
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 0
                }).format(amount);
            }

            exportData() {
                const data = {
                    leads: this.getFilteredLeads(),
                    exportDate: new Date().toISOString(),
                    filters: this.filters
                };
                
                const dataStr = JSON.stringify(data, null, 2);
                const dataBlob = new Blob([dataStr], {type:'application/json'});
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = `leads-export-${new Date().toISOString().split('T')[0]}.json`;
                link.click();
            }
        }

        // Initialize CRM Dashboard
        const crm = new CRMDashboard();

        // Global Functions
        function openLeadDetail(leadId) {
            crm.openLeadDetail(leadId);
        }

        function closeModal() {
            document.getElementById('leadModal').classList.remove('active');
        }

        function loadEmailTemplate(templateName) {
            // Update template button states
            document.querySelectorAll('.template-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            const template = crm.emailTemplates[templateName];
            if (template) {
                document.getElementById('emailSubject').value = template.subject;
                document.getElementById('emailMessage').value = template.body;
            }
        }

        function sendMessage(event, leadId) {
            crm.sendMessage(event, leadId);
        }

        function updateLeadStatus(leadId) {
            const newStatus = prompt('Enter new status (new, contacted, qualified, paid_deposit):', '');
            if (newStatus && ['new', 'contacted', 'qualified', 'paid_deposit'].includes(newStatus)) {
                crm.updateLead(leadId, { status: newStatus });
                alert('Status updated successfully!');
            }
        }

        function scheduleFollowup(leadId) {
            const followUpDate = prompt('Enter follow-up date (YYYY-MM-DD):', '');
            if (followUpDate) {
                crm.updateLead(leadId, { followUpDate: followUpDate });
                alert('Follow-up scheduled successfully!');
            }
        }

        function markAsPaid(leadId) {
            const depositAmount = prompt('Enter deposit amount:', '');
            if (depositAmount && !isNaN(depositAmount)) {
                crm.updateLead(leadId, { 
                    status: 'paid_deposit',
                    depositAmount: parseFloat(depositAmount)
                });
                alert('Lead marked as paid!');
            }
        }

        function addNewLead() {
            // Redirect to configurator or show add lead form
            window.location.href = 'enhanced-client-proposal-phase3.html';
        }

        function sendBulkEmail() {
            alert('Bulk email feature coming soon!');
        }

        function exportLeads() {
            crm.exportData();
        }

        function syncIntegrations() {
            alert('Syncing with external systems...');
            // Simulate sync delay
            setTimeout(() => {
                crm.updateLastSync();
                alert('Sync completed successfully!');
            }, 2000);
        }

        function refreshLeads() {
            crm.updateStats();
            crm.renderLeads();
            crm.updateLastSync();
        }

        function sendEmail(leadId) {
            crm.openLeadDetail(leadId);
        }

        function updateStatus(leadId) {
            updateLeadStatus(leadId);
        }

        function addNote(leadId) {
            const note = prompt('Add a note:', '');
            if (note) {
                const lead = crm.leads.find(l => l.id == leadId);
                if (lead) {
                    lead.notes = lead.notes || [];
                    lead.notes.push({
                        text: note,
                        date: new Date().toISOString()
                    });
                    crm.saveData();
                    alert('Note added successfully!');
                }
            }
        }

        function saveDraft(leadId) {
            const subject = document.getElementById('emailSubject').value;
            const message = document.getElementById('emailMessage').value;
            
            localStorage.setItem(`draft_${leadId}`, JSON.stringify({ subject, message }));
            alert('Draft saved!');
        }

        function generateProposal(leadId) {
            // Redirect to proposal generator
            window.location.href = `enhanced-client-proposal-phase3.html?lead=${leadId}`;
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Apply configuration if available
            if (window.CONFIG) {
                document.getElementById('crm-title').textContent = `${window.CONFIG.companyName} CRM`;
                document.getElementById('crm-subtitle').textContent = 'Manage leads, track interactions, and automate communications';
            }
        });

        // Close modal when clicking outside
        document.getElementById('leadModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });
    </script>
</body>
</html>